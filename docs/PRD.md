# code-rag - Product Requirements Document

**Author:** commander
**Date:** 2025-11-11
**Version:** 1.0

---

## Executive Summary

code-rag 作为企业内网的代码增强型知识库，持续聚焦“5 秒内提供可靠业务代码参考”这一核心愿景。当前目标是面向企业业务工程团队，统一飞书 PRD、GitLab 代码、数据库上下文三类关键资产，让业务 agent 能在一次查询中就获得可追溯、可验证的实现建议。我们将坚持现有愿景，不再做战略性调整，确保在 2 个月内交付一个上线可用的版本，帮助业务团队显著缩短沟通与迭代周期。

### What Makes This Special

当业务工程师提出新需求或改动诉求时，code-rag 会即时返回“差异视角”的答案：不仅指出需要新增或修改的功能，还给出与之对应的高质量代码实现示例，并附上 PRD 原文与历史代码引用。用户在同一个界面中即可看到“改什么、为何改、怎么改”，这是他们真正会为之买单的魔力时刻。

---

## Project Classification

**Technical Type:** 内部 SaaS 平台（API 驱动）
**Domain:** 企业知识管理 / 开发协作
**Complexity:** 中等

code-rag 聚焦在内网环境下的知识与代码服务整合，采用“API 优先，Web 控制台补充”的交付策略。核心用法是将检索与推理能力通过接口嵌入现有业务 agent 与自动化工作流，同时提供轻量级 Web 控制台用于设置数据源、监控指标与人工审查。系统需对接飞书、GitLab、自建数据库等多源数据，强调数据脱敏、权限隔离与操作可审计。无需遵循特定行业合规标准，但必须符合企业内部安全与访问审计规范，整体复杂度评估为中等。

{{#if domain_context_summary}}

### Domain Context

{{domain_context_summary}}
{{/if}}

---

## Success Criteria

- 优先保障信息准确性：当检索结果无法确认可靠性时，应返回“疑似”或“未命中”提示，而非强行生成答案。
- API 与 Web 控制台需支持“来源追溯”机制，确保所有推荐内容附带原始 PRD、代码或数据库链接，便于用户快速交叉验证。
- 用户采纳率目标 ≥ 70%，且保持稳定或持续提升；用户主观反馈以正向评价为主（满意度 ≥ 4/5）。
- 支持业务 agent 在单次交互内识别变更范围，包括新增、修改、影响面，并给出相应代码建议；对无法确认的部分应明确标记需要人工确认。

### Business Metrics

- 业务流程完成时间：典型需求从提出到初版代码交付的周期缩短 40% 以上。
- 代码生成一次命中率：首次给出的实现建议能够满足需求的比例 ≥ 60%，并通过迭代提升。
- 多轮问答最终解决率：在与知识库交互不超过 3 轮的情况下，用户能够完成需求或获得明确下一步指引的比例 ≥ 85%。

---

## Product Scope
### MVP - Minimum Viable Product
- 建立飞书 PRD、GitLab 代码库、自建数据库三类数据源的同步流程，并成功落地至少一批真实数据用于演示与内部试点。
- 提供统一 API，支持业务 agent 和 Web 前端调用，具备检索、引用追踪、差异提示的核心能力。
- Web 控制台实现基础的数据浏览、检索结果审查以及关键指标（检索次数、命中率、响应时长等）报表展示，至少覆盖主要数据维度。
- 所有输出均附带来源引用，确保可追溯性；当检索结果不可信时能够返回“疑似/未命中”状态。

### Growth Features (Post-MVP)
- 优化向量检索与 rerank 算法，显著提升相关度与一次命中率，并持续跟踪采纳率指标。
- 引入提示模板与上下文拼接策略的配置中心，让团队可以自定义针对不同业务场景的回答风格与严谨度。
- 支持数据预处理与同步策略的可视化配置（例如字段脱敏、分段策略、更新频次），加强运维与迭代效率。

### Vision (Future)
- 构建需求与功能的“时间线档案”视图，自动串联 PRD、代码提交、变更记录，帮助用户追踪全历史演进。
- 提供多版本差异比较、自动生成变更摘要与影响分析，让用户快速理解每次改动背后的逻辑。
- 通过自适应交互与语义理解，即便用户描述模糊，也能推断真实意图并以最小成本给出满足预期的解决方案。

---

{{#if domain_considerations}}

## Domain-Specific Requirements

{{domain_considerations}}

This section shapes all functional and non-functional requirements below.
{{/if}}

---

## Innovation & Novel Patterns
- 低学习成本的知识共建：计划面向产品与 UI 团队提供“所见即所得”的素材上传与标记入口，让非技术成员也能参与知识库维护，缩短知识滞后。
- 多角色视角的检索逻辑：构建针对开发、产品、UI 不同角色的检索权重与呈现方式，实现“按角色看到对自己最有用的信息”。
- 自动对齐需求与代码：探索将需求片段与历史代码自动匹配的算法，给出可直接引用的实现建议与差异说明。
- 验证失败兜底策略：一旦自研算法无法满足准确性与效率目标，将评估市场成熟方案（如现成的知识管理或代码检索平台），在降低标准的前提下先保证流程可落地。

{{#if innovation_patterns}}
## Innovation & Novel Patterns
{{innovation_patterns}}

### Validation Approach
{{validation_approach}}
{{/if}}

---

## SaaS/B2B Specific Requirements
- 租户模型：当前面向单一企业内部使用，暂不开放多租户；后续若商业化，需要预留逻辑隔离或独立部署的扩展能力。
- 权限体系：至少支持管理员、产品、UI、开发四类角色；管理员负责数据源管理、权限配置；产品/UI 侧专注内容共建与审核；开发侧聚焦检索与差异分析。
- 订阅/计费：短期无计费需求，但未来可能接入 SaaS 商用，需在数据模型与接口协议上预留计量与收费扩展点。
- 集成接口：核心集成包含飞书、GitLab、自建数据库；需根据成本评估是否在 MVP 中提供 webhook 或事件流以通知检索命中、文档更新等事件。
- 合规与监控：上线初期以内部使用为主，可先收集基础操作日志；后续规划审计日志、异常警报与可视化指标看板。
- 核心 API：
  - 查询：支持多角色视角的检索与引用追溯。
  - 差异分析：比较新增/修改内容与历史实现，输出差异总结。
  - 文档提交：接收产品/UI 上传的 PRD、设计稿、知识片段并自动入库。
  - 审核标记：提供人工确认或退回机制，确保知识质量闭环。

{{#if project_type_requirements}}

## {{project_type}} Specific Requirements

{{project_type_requirements}}

{{#if endpoint_specification}}

### API Specification

{{endpoint_specification}}
{{/if}}

{{#if authentication_model}}

### Authentication & Authorization

{{authentication_model}}
{{/if}}

{{#if platform_requirements}}

### Platform Support

{{platform_requirements}}
{{/if}}

{{#if device_features}}

### Device Capabilities

{{device_features}}
{{/if}}

{{#if tenant_model}}

### Multi-Tenancy Architecture

{{tenant_model}}
{{/if}}

{{#if permission_matrix}}

### Permissions & Roles

{{permission_matrix}}
{{/if}}
{{/if}}

---

## User Experience Principles
- 整体体验定位：界面风格倾向轻量高效，强调信息密度与快速反馈，尽量减少复杂视觉元素，让用户快速聚焦在关键数据与操作上。
- 核心用户旅程：
  - 管理员：登录后优先看到数据看板（数据源状态、命中率、反馈概览），并能快速跳转到权限配置或集成设置。
  - 产品/UI：集中管理 PRD 与设计资源，可标记需要 UI 补充的内容，并对疑似缺失的上下文发起补充提醒。
  - 开发：通过检索入口快速获取历史代码、相关 PRD 片段与设计稿摘要，同时生成待办列表并查看个人或团队的历史使用记录。
- 交互与反馈：当系统判断结果为“疑似/未命中”时，限制返回不超过 3 条候选文档，并明确要求用户确认或补充信息；审核环节必须提供“确认/退回”操作与原因记录。
- 可访问性与适配：当前聚焦桌面端体验，不强制支持移动端或夜间模式；后续可根据反馈逐步扩展。

{{#if ux_principles}}
## User Experience Principles
{{ux_principles}}

### Key Interactions
{{key_interactions}}
{{/if}}

---

## Functional Requirements

### 1. 数据源同步与管理
**FR-1.1 多数据源接入**
- 支持飞书文档（PRD、需求文档）、GitLab 代码库、自建数据库三类数据源的配置与连接。
- 验收标准：管理员可在 Web 控制台配置至少三种数据源，系统能成功建立连接并完成首次数据拉取。
- 用户价值：统一企业内部分散的知识资产，为后续检索提供数据基础。

**FR-1.2 数据同步流程**
- 提供定时同步与手动触发同步两种模式，支持增量更新与全量重建。
- 验收标准：同步任务可配置执行频率，失败时能记录错误日志并通知管理员；增量同步仅处理变更内容。
- 用户价值：确保知识库内容与源系统保持一致性，减少人工维护成本。

**FR-1.3 数据源状态监控**
- 在管理员看板中展示各数据源的连接状态、最后同步时间、数据量统计、同步错误记录。
- 验收标准：看板实时反映数据源健康度，异常状态有明确提示与处理建议。
- 用户价值：管理员可快速发现并处理数据源问题，保障系统可用性。

### 2. 智能检索与引用追溯
**FR-2.1 多角色视角检索**
- 支持按开发、产品、UI 三种角色视角返回差异化检索结果，开发侧重代码与实现，产品侧重需求与上下文，UI 侧重设计稿与交互说明。
- 验收标准：同一查询在不同角色视角下返回结果的相关度排序与内容摘要有明显差异，且符合角色关注点。
- 用户价值：每个角色都能快速找到对自己最有用的信息，减少信息噪音。

**FR-2.2 准确性优先的检索策略**
- 当检索结果置信度低于阈值时，系统返回“疑似/未命中”状态，最多提供 3 条候选文档供用户确认，而非强行生成答案。
- 验收标准：系统能计算检索结果置信度，低于阈值时明确标记“疑似”，并限制候选数量；用户可对疑似结果进行确认或补充信息。
- 用户价值：降低幻觉风险，宁可查不到也不给出错误信息，保障采纳率与用户信任。

**FR-2.3 来源引用与可追溯性**
- 所有检索结果必须附带原始来源链接（飞书文档链接、GitLab 代码文件路径与行号、数据库记录标识），并提供元信息（作者、更新时间、版本）。
- 验收标准：每条检索结果包含至少一个可点击的来源链接，点击后能跳转到原始内容；元信息完整且准确。
- 用户价值：用户可快速验证检索结果的可靠性，并追溯上下文，这是“魔力时刻”的核心支撑。

**FR-2.4 检索历史记录**
- 记录用户的检索查询、返回结果、采纳情况与反馈，支持按时间、关键词、角色筛选查看。
- 验收标准：开发角色可在个人或团队视角查看历史检索记录，包含查询内容、命中结果、采纳状态。
- 用户价值：帮助用户回顾与复用历史查询，提升检索效率。

### 3. 差异分析与代码建议
**FR-3.1 需求与代码自动对齐**
- 当用户提出新需求或修改诉求时，系统能识别需要新增或修改的功能点，并匹配历史相关代码，输出差异总结与实现建议。
- 验收标准：输入需求描述后，系统能输出“新增/修改/影响面”三类变更范围，并给出对应代码示例与引用链接。
- 用户价值：这是产品的“魔力时刻”——用户在同一界面看到“改什么、为何改、怎么改”，显著缩短理解与实现周期。

**FR-3.2 差异总结生成**
- 自动生成变更摘要，包括新增功能点、修改点、影响范围，并附上相关 PRD 片段与历史代码对比。
- 验收标准：差异总结清晰可读，包含具体变更项与对应来源，用户能快速理解改动逻辑。
- 用户价值：帮助开发快速理解需求变更，减少沟通轮次。

**FR-3.3 待办列表生成**
- 基于差异分析结果，自动生成待办事项列表，包含任务描述、优先级、关联文档与代码引用。
- 验收标准：开发角色在检索后能获得结构化的待办列表，可直接用于任务管理工具或开发流程。
- 用户价值：将检索结果转化为可执行的开发任务，提升工作流效率。

### 4. 内容共建与知识管理
**FR-4.1 低学习成本的内容上传**
- 产品与 UI 角色可通过 Web 控制台上传 PRD、设计稿、知识片段，支持拖拽上传与批量导入，系统自动解析并入库。
- 验收标准：非技术用户能在 5 分钟内完成一次文档上传，系统能识别文档类型并提取关键信息。
- 用户价值：降低知识共建门槛，让产品与 UI 团队主动参与知识库维护。

**FR-4.2 PRD 与设计资源管理**
- 产品角色可集中管理 PRD 文档，UI 角色可管理设计稿资源，支持版本管理、标签分类、搜索筛选。
- 验收标准：产品/UI 角色能在控制台中查看、编辑、删除自己上传的文档，并能按标签或关键词快速定位。
- 用户价值：统一管理产品与设计资产，避免文档散落与版本混乱。

**FR-4.3 UI 需求提炼**
- UI 角色可从 PRD 中识别需要新设计的内容，系统自动标记并生成设计任务清单。
- 验收标准：UI 角色在查看 PRD 时能标记“需要设计”的段落，系统汇总生成设计待办列表。
- 用户价值：帮助 UI 团队提前识别设计需求，缩短设计周期。

### 5. 审核与质量控制
**FR-5.1 人工审核机制**
- 当系统返回“疑似”结果或用户上传新内容时，支持人工审核流程，提供“确认/退回”操作与原因记录。
- 验收标准：审核界面清晰展示待审核内容与系统判断依据，审核人可填写退回原因，审核结果影响知识库状态。
- 用户价值：确保知识库内容质量，减少错误信息传播。

**FR-5.2 审核标记与反馈**
- 用户可对检索结果进行采纳/拒绝标记，并提供反馈意见，系统记录并用于算法优化。
- 验收标准：每条检索结果提供反馈入口，用户标记后系统记录采纳率与反馈内容，管理员可在看板查看统计。
- 用户价值：形成质量闭环，持续提升检索准确性。

### 6. 权限与角色管理
**FR-6.1 四角色权限体系**
- 支持管理员、产品、UI、开发四类角色，每类角色拥有不同的功能权限与数据访问范围。
- 验收标准：管理员可配置角色权限，不同角色登录后看到的功能菜单与数据范围符合权限定义。
- 用户价值：保障数据安全，确保各角色专注于自身职责。

**FR-6.2 权限配置界面**
- 管理员可在 Web 控制台配置角色权限、用户分配、数据源访问控制。
- 验收标准：管理员能通过界面完成权限配置，无需修改代码，配置生效后立即反映在用户界面。
- 用户价值：灵活管理团队权限，适应组织变化。

### 7. 监控与报表
**FR-7.1 数据看板**
- 管理员看板展示数据源状态、检索次数、命中率、响应时长、采纳率、用户反馈概览等关键指标。
- 验收标准：看板数据实时更新，指标计算准确，支持按时间范围筛选查看趋势。
- 用户价值：帮助管理员了解系统运行状况，识别优化方向。

**FR-7.2 基础报表**
- 提供检索统计、用户活跃度、数据源使用情况等基础报表，支持导出 CSV 或 PDF。
- 验收标准：报表数据准确，导出功能正常，报表格式清晰易读。
- 用户价值：为管理层提供数据支撑，证明系统价值。

---

## Non-Functional Requirements

### Performance
- **API 响应时间**：检索接口 P95 响应时间 < 5 秒，确保满足“5 秒内提供可靠业务代码参考”的核心目标。
- **并发支持**：系统需支持同时在线用户数 < 200，满足企业内部使用规模。
- **数据量规模**：支持文档数量 1000+，代码库 50+，系统需在数据量增长时保持检索性能稳定。
- **验收标准**：在目标数据量下，检索接口 P95 < 5 秒，系统能稳定支持 200 并发用户。

### Security
- **认证方式**：采用 SSO（单点登录）认证，与企业内部身份系统集成，简化用户登录流程。
- **数据脱敏**：当前阶段暂不实施数据脱敏，后续根据合规需求评估是否需要。
- **访问审计**：记录用户的提问内容与采纳结果，形成操作日志，支持后续审计与分析。
- **验收标准**：用户通过 SSO 登录后能正常访问系统，所有检索查询与采纳操作均有日志记录。

### Scalability
- **数据源扩展**：系统架构需预留扩展能力，未来支持蓝湖、Figma 等设计工具的数据源接入。
- **用户规模增长**：系统需支持用户规模增长至当前 20 倍（即约 4000 用户），架构设计需考虑水平扩展能力。
- **验收标准**：新增数据源类型时无需重构核心架构，系统能在用户规模增长时通过扩容保持性能。

### Integration
- **Webhook/事件流**：MVP 阶段非必须，后续根据实际需求与成本评估决定是否实现。
- **API 版本管理**：采用手动版本管理策略，通过 URL 路径或请求头标识 API 版本，确保向后兼容。
- **验收标准**：API 接口具备版本标识机制，新版本发布不影响现有调用方。

### Availability & Operations
- **可用性目标**：系统可用性目标为 80%，满足内部使用的基本要求。
- **部署方式**：部署在阿里云服务器，采用容器化部署方式，便于后续扩展与维护。
- **监控告警**：MVP 阶段暂不加入监控告警功能，后续根据运维需求逐步完善。
- **验收标准**：系统能在阿里云环境稳定运行，可用性达到 80% 以上。

---

## PRD Summary

### 核心愿景
code-rag 作为企业内网的代码增强型知识库，聚焦“5 秒内提供可靠业务代码参考”，统一飞书 PRD、GitLab 代码、数据库上下文三类关键资产，让业务 agent 能在一次查询中获得可追溯、可验证的实现建议。

### 产品魔力
当业务工程师提出新需求或改动诉求时，code-rag 会即时返回“差异视角”的答案：不仅指出需要新增或修改的功能，还给出与之对应的高质量代码实现示例，并附上 PRD 原文与历史代码引用。用户在同一个界面中即可看到“改什么、为何改、怎么改”，这是他们真正会为之买单的魔力时刻。

### 成功标准
- 信息准确性优先：宁可查不到也不给出错误信息，降低幻觉风险
- 用户采纳率 ≥ 70%，满意度 ≥ 4/5
- 业务流程完成时间缩短 40% 以上
- 代码生成一次命中率 ≥ 60%

### 功能范围
- **MVP**：数据源同步（飞书、GitLab、数据库）、统一 API、Web 控制台、引用追溯、疑似提示
- **Growth**：优化检索算法、配置中心、数据预处理可视化
- **Vision**：时间线档案、多版本差异比较、自适应语义理解

### 功能需求概览
共 7 个能力域、17 个功能点：
1. 数据源同步与管理（3 个功能点）
2. 智能检索与引用追溯（4 个功能点）
3. 差异分析与代码建议（3 个功能点）
4. 内容共建与知识管理（3 个功能点）
5. 审核与质量控制（2 个功能点）
6. 权限与角色管理（2 个功能点）
7. 监控与报表（2 个功能点）

### 非功能性需求
- **性能**：检索接口 P95 < 5 秒，支持 200 并发用户，数据量 1000+ 文档、50+ 代码库
- **安全**：SSO 认证，记录提问与采纳结果
- **可扩展性**：支持未来接入蓝湖、Figma，用户规模增长 20 倍
- **可用性**：目标 80%，部署在阿里云服务器，容器化部署

### 上线时间
目标 2 个月内交付上线可用版本。

---

## Implementation Planning

### Epic Breakdown Required

Requirements must be decomposed into epics and bite-sized stories (200k context limit).

**Next Step:** Run `workflow epics-stories` to create the implementation breakdown.

---

## References

- Product Brief: docs/bmm-product-brief-code-rag-2025-11-11.md
- Domain Brief: 暂无（后续可通过飞书 MCP 接入）
- Research: docs/bmm-research-technical-2025-11-11.md

---

## Next Steps

1. **Epic & Story Breakdown** - Run: `workflow epics-stories`
2. **UX Design** (if UI) - Run: `workflow ux-design`
3. **Architecture** - Run: `workflow create-architecture`

---

_This PRD captures the essence of code-rag - 当业务工程师提出新需求或改动诉求时，code-rag 会即时返回“差异视角”的答案：不仅指出需要新增或修改的功能，还给出与之对应的高质量代码实现示例，并附上 PRD 原文与历史代码引用。用户在同一个界面中即可看到“改什么、为何改、怎么改”，这是他们真正会为之买单的魔力时刻。_

_Created through collaborative discovery between commander and AI facilitator._

